<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מחשבון רכב: ליסינג מול קנייה</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals & Teal -->
    <!-- Application Structure Plan: A two-column responsive layout for the main calculator and a new section below for saved deals. The left column of the calculator contains all user inputs (sliders and number fields) grouped by category. The right column is dedicated to dynamic outputs: a summary card, a bar chart, and a donut chart. This interactive dashboard structure provides immediate feedback for "what-if" scenarios. The new "Saved Opportunities" section allows users to save and manage different car deals they find. This adds a crucial long-term comparison capability, enhancing the app's utility from a one-off calculator to a personal research tool. -->
    <!-- Visualization & Content Choices: 
        1. Report Info: Overall comparison result. Goal: Inform. Viz: Summary Card (HTML/CSS). Interaction: None (dynamic text). Justification: Provides a clear, immediate answer.
        2. Report Info: Total cost of buying vs. leasing. Goal: Compare. Viz: Bar Chart (Chart.js/Canvas). Interaction: Hover tooltips for exact values. Justification: The simplest and most effective way to compare two primary values.
        3. Report Info: Component costs (depreciation, interest, fees, etc.). Goal: Organize/Inform. Viz: Donut Chart (Chart.js/Canvas). Interaction: Buttons to toggle between Buy/Lease breakdown. Justification: Shows the proportion of each cost component, helping users understand where the money goes. Toggling keeps the UI clean.
        4. Report Info: All numerical inputs. Goal: User Input. Viz: HTML Sliders & Number Inputs. Interaction: User modification triggers recalculation. Justification: Combines tactile exploration (sliders) with precision (number fields).
        5. Report Info: Saved car deals. Goal: Store & Recall. Viz: Dynamic List (HTML/JS). Interaction: Buttons to save new deals, load old deals into the calculator, and delete them. Justification: Adds persistent data storage via localStorage, transforming the app into a practical tool for long-term financial planning. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Rubik', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #0d9488;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #0d9488;
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 dark:bg-slate-900 dark:text-slate-200" dir="rtl">

    <div class="container mx-auto p-4 md:p-8">
        <div class="flex justify-end mb-4">
            <button id="theme-toggle" type="button" class="text-stone-500 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-stone-700 focus:outline-none focus:ring-4 focus:ring-stone-200 dark:focus:ring-stone-700 rounded-lg text-sm p-2.5">
                <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1zM6.464 16.364l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414zM13.536 6.464l.707-.707a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414z"></path></svg>
            </button>
        </div>
        <header class="text-center mb-12">
            <div class="relative rounded-2xl overflow-hidden shadow-lg mb-8">
                <img src="https://via.placeholder.com/1200x400/0d9488/FFFFFF" alt="A placeholder image of a car" class="w-full h-auto object-cover">
                <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center">
                    <div class="text-center">
                        <h1 class="text-4xl md:text-5xl font-bold text-white">מחשבון רכב: ליסינג מול קנייה</h1>
                        <p class="text-white mt-2 text-xl">הכלי החכם להחלטה כלכלית נבונה</p>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content" class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <div id="left-column" class="lg:col-span-2 flex flex-col gap-8">
                <!-- Input Controls Panel -->
                <div id="input-panel" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-xl font-semibold text-teal-700 dark:text-teal-400 border-b-2 border-teal-100 dark:border-teal-800 pb-2 mb-4">פרטי הרכב</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="purchasePrice" class="block text-sm font-medium text-stone-700 dark:text-slate-300">מחיר רכישה (P)</label>
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        <input type="range" id="purchasePrice" min="50000" max="500000" step="5000" value="200000" class="w-full h-2 bg-stone-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                        <span id="purchasePriceValue" class="font-semibold text-teal-800 dark:text-teal-400 w-28 text-left">200,000 ₪</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="residualValue" class="block text-sm font-medium text-stone-700 dark:text-slate-300">שווי גרט (V_res)</label>
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        <input type="range" id="residualValue" min="20000" max="300000" step="5000" value="100000" class="w-full h-2 bg-stone-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                        <span id="residualValueValue" class="font-semibold text-teal-800 dark:text-teal-400 w-28 text-left">100,000 ₪</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="comparisonPeriod" class="block text-sm font-medium text-stone-700 dark:text-slate-300">תקופת השוואה (T)</label>
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        <input type="range" id="comparisonPeriod" min="12" max="60" step="1" value="36" class="w-full h-2 bg-stone-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                        <span id="comparisonPeriodValue" class="font-semibold text-teal-800 dark:text-teal-400 w-28 text-left">36 חודשים</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xl font-semibold text-teal-700 dark:text-teal-400 border-b-2 border-teal-100 dark:border-teal-800 pb-2 mb-4 flex items-center gap-x-2">
                                <img src="https://via.placeholder.com/40x40/0d9488/FFFFFF" alt="Key icon" class="w-8 h-8 rounded-md">
                                <span>אופציית קנייה</span>
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="downPayment" class="block text-sm font-medium text-stone-700 dark:text-slate-300">מקדמה (D)</label>
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        <input type="range" id="downPayment" min="0" max="250000" step="5000" value="50000" class="w-full h-2 bg-stone-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                        <span id="downPaymentValue" class="font-semibold text-teal-800 dark:text-teal-400 w-28 text-left">50,000 ₪</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="interestRate" class="block text-sm font-medium text-stone-700 dark:text-slate-300">ריבית שנתית (I)</label>
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        <input type="range" id="interestRate" min="1" max="10" step="0.1" value="4.5" class="w-full h-2 bg-stone-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                        <span id="interestRateValue" class="font-semibold text-teal-800 dark:text-teal-400 w-28 text-left">4.5 %</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xl font-semibold text-teal-700 dark:text-teal-400 border-b-2 border-teal-100 dark:border-teal-800 pb-2 mb-4 flex items-center gap-x-2">
                                <img src="https://via.placeholder.com/40x40/0ea5e9/FFFFFF" alt="Calendar icon" class="w-8 h-8 rounded-md">
                                <span>אופציית ליסינג</span>
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="leaseInitialPayment" class="block text-sm font-medium text-stone-700 dark:text-slate-300">תשלום ראשוני (D_lease)</label>
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        <input type="range" id="leaseInitialPayment" min="0" max="50000" step="1000" value="15000" class="w-full h-2 bg-stone-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                        <span id="leaseInitialPaymentValue" class="font-semibold text-teal-800 dark:text-teal-400 w-28 text-left">15,000 ₪</span>
                                    </div>
                                </div>
                                <div>
                                    <label for="leaseMonthlyPayment" class="block text-sm font-medium text-stone-700 dark:text-slate-300">תשלום חודשי (C_lease)</label>
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        <input type="range" id="leaseMonthlyPayment" min="1000" max="7000" step="100" value="2800" class="w-full h-2 bg-stone-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                        <span id="leaseMonthlyPaymentValue" class="font-semibold text-teal-800 dark:text-teal-400 w-28 text-left">2,800 ₪</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xl font-semibold text-teal-700 dark:text-teal-400 border-b-2 border-teal-100 dark:border-teal-800 pb-2 mb-4">עלויות שנתיות נוספות</h3>
                            <div class="space-y-4">
                                <label for="insuranceCost" class="block text-sm font-medium text-stone-700 dark:text-slate-300">עלות ביטוח שנתית (C_ins)</label>
                                <input type="number" id="insuranceCost" value="6500" class="w-full p-2 border border-stone-300 dark:bg-slate-700 dark:border-slate-600 rounded-md">

                                <label for="licenseFee" class="block text-sm font-medium text-stone-700 dark:text-slate-300">אגרת רישוי שנתית (C_lic)</label>
                                <input type="number" id="licenseFee" value="1800" class="w-full p-2 border border-stone-300 dark:bg-slate-700 dark:border-slate-600 rounded-md">

                                <label for="maintenanceCost" class="block text-sm font-medium text-stone-700 dark:text-slate-300">עלות אחזקה שנתית (C_maint)</label>
                                <input type="number" id="maintenanceCost" value="2500" class="w-full p-2 border border-stone-300 dark:bg-slate-700 dark:border-slate-600 rounded-md">

                                <label for="fuelMiscCost" class="block text-sm font-medium text-stone-700 dark:text-slate-300">דלק והוצאות שונות (שנתי)</label>
                                <input type="number" id="fuelMiscCost" value="10000" class="w-full p-2 border border-stone-300 dark:bg-slate-700 dark:border-slate-600 rounded-md">

                                <label for="investmentReturnRate" class="block text-sm font-medium text-stone-700 dark:text-slate-300">תשואה על השקעה (שנתי)</label>
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <input type="range" id="investmentReturnRate" min="1" max="10" step="0.1" value="5" class="w-full h-2 bg-stone-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                    <span id="investmentReturnRateValue" class="font-semibold text-teal-800 dark:text-teal-400 w-28 text-left">5.0 %</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Panel -->
            <div id="right-column" class="lg:col-span-3 flex flex-col gap-8">
                <div id="summaryCard" class="p-6 rounded-2xl shadow-lg text-center transition-all duration-300 bg-white dark:bg-slate-800">
                    <h2 id="summaryTitle" class="text-2xl md:text-3xl font-bold"></h2>
                    <p id="summarySubtitle" class="text-lg mt-1"></p>
                </div>
                
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-semibold text-center mb-4 text-teal-700 dark:text-teal-400">השוואת עלות כוללת לתקופה</h3>
                    <div class="chart-container">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-semibold text-center mb-4 text-teal-700 dark:text-teal-400">פירוט עלויות</h3>
                     <div class="flex justify-center mb-4">
                        <div class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" id="showBuyBreakdown" class="px-4 py-2 text-sm font-medium text-white bg-teal-600 border border-teal-600 rounded-r-lg hover:bg-teal-700 focus:z-10 focus:ring-2 focus:ring-teal-500 dark:bg-teal-700 dark:border-teal-700 dark:hover:bg-teal-600">
                                קנייה
                            </button>
                            <button type="button" id="showLeaseBreakdown" class="px-4 py-2 text-sm font-medium text-teal-700 bg-white border-t border-b border-teal-600 hover:bg-stone-50 focus:z-10 focus:ring-2 focus:ring-teal-500 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700">
                                ליסינג
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="breakdownChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
        
        <hr class="my-12 border-stone-300 dark:border-slate-700">

        <section class="mt-8">
            <h2 class="text-2xl md:text-3xl font-bold text-center mb-6 text-teal-800 dark:text-teal-400">הזדמנויות שמורות</h2>
            <p class="text-center text-stone-600 dark:text-slate-400 mb-8 max-w-2xl mx-auto">כאן תוכלו לשמור פרטים של מכוניות שאתם שוקלים כדי לחזור אליהן מאוחר יותר ולהשוות בקלות.</p>

            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg mb-8">
                <h3 class="text-xl font-semibold text-teal-700 dark:text-teal-400 border-b-2 border-teal-100 dark:border-teal-800 pb-2 mb-4">שמירת הזדמנות חדשה</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="saveName" class="block text-sm font-medium text-stone-700 dark:text-slate-300">שם העסקה (לדוגמא: טויוטה קורולה ליסינג)</label>
                        <input type="text" id="saveName" class="w-full p-2 border border-stone-300 dark:bg-slate-700 dark:border-slate-600 rounded-md" placeholder="שם העסקה">
                    </div>
                    <div>
                        <label for="saveMake" class="block text-sm font-medium text-stone-700 dark:text-slate-300">יצרן</label>
                        <input type="text" id="saveMake" class="w-full p-2 border border-stone-300 dark:bg-slate-700 dark:border-slate-600 rounded-md" placeholder="טויוטה, יונדאי וכו'">
                    </div>
                    <div class="md:col-span-2">
                        <button id="saveDealBtn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors dark:bg-teal-700 dark:hover:bg-teal-600">
                            שמור עסקה
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-semibold text-teal-700 dark:text-teal-400 border-b-2 border-teal-100 dark:border-teal-800 pb-2 mb-4">ההזדמנויות השמורות שלי</h3>
                <div id="savedDealsList" class="space-y-4">
                    <p class="text-center text-stone-500 dark:text-slate-400" id="noDealsMessage">אין עסקאות שמורות.</p>
                </div>
            </div>

        </section>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const inputs = {
            purchasePrice: document.getElementById('purchasePrice'),
            residualValue: document.getElementById('residualValue'),
            comparisonPeriod: document.getElementById('comparisonPeriod'),
            downPayment: document.getElementById('downPayment'),
            interestRate: document.getElementById('interestRate'),
            leaseInitialPayment: document.getElementById('leaseInitialPayment'),
            leaseMonthlyPayment: document.getElementById('leaseMonthlyPayment'),
            insuranceCost: document.getElementById('insuranceCost'),
            licenseFee: document.getElementById('licenseFee'),
            maintenanceCost: document.getElementById('maintenanceCost'),
            fuelMiscCost: document.getElementById('fuelMiscCost'),
            investmentReturnRate: document.getElementById('investmentReturnRate'),
        };

        const values = {
            purchasePriceValue: document.getElementById('purchasePriceValue'),
            residualValueValue: document.getElementById('residualValueValue'),
            comparisonPeriodValue: document.getElementById('comparisonPeriodValue'),
            downPaymentValue: document.getElementById('downPaymentValue'),
            interestRateValue: document.getElementById('interestRateValue'),
            leaseInitialPaymentValue: document.getElementById('leaseInitialPaymentValue'),
            leaseMonthlyPaymentValue: document.getElementById('leaseMonthlyPaymentValue'),
            investmentReturnRateValue: document.getElementById('investmentReturnRateValue'),
        };

        const summary = {
            card: document.getElementById('summaryCard'),
            title: document.getElementById('summaryTitle'),
            subtitle: document.getElementById('summarySubtitle'),
        };
        
        const breakdownButtons = {
            buy: document.getElementById('showBuyBreakdown'),
            lease: document.getElementById('showLeaseBreakdown'),
        };

        const savedDeals = {
            name: document.getElementById('saveName'),
            make: document.getElementById('saveMake'),
            btn: document.getElementById('saveDealBtn'),
            list: document.getElementById('savedDealsList'),
            noDealsMessage: document.getElementById('noDealsMessage')
        };

        let activeBreakdown = 'buy';

        const formatCurrency = (num) => `${Math.round(num).toLocaleString('he-IL')} ₪`;

        const updateValueDisplays = (source = inputs) => {
            values.purchasePriceValue.textContent = formatCurrency(source.purchasePrice.value);
            values.residualValueValue.textContent = formatCurrency(source.residualValue.value);
            values.comparisonPeriodValue.textContent = `${source.comparisonPeriod.value} חודשים`;
            values.downPaymentValue.textContent = formatCurrency(source.downPayment.value);
            values.interestRateValue.textContent = `${parseFloat(source.interestRate.value).toFixed(1)} %`;
            values.leaseInitialPaymentValue.textContent = formatCurrency(source.leaseInitialPayment.value);
            values.leaseMonthlyPaymentValue.textContent = formatCurrency(source.leaseMonthlyPayment.value);
            values.investmentReturnRateValue.textContent = `${parseFloat(source.investmentReturnRate.value).toFixed(1)} %`;
        };

        const isDarkMode = () => document.documentElement.classList.contains('dark');
        const getChartColors = () => ({
            textColor: isDarkMode() ? 'rgb(203 213 225)' : 'rgb(55 65 81)',
            gridColor: isDarkMode() ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
        });

        const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
        const comparisonChart = new Chart(comparisonCtx, {
            type: 'bar',
            data: {
                labels: ['קנייה', 'ליסינג'],
                datasets: [{
                    label: 'עלות כוללת',
                    data: [0, 0],
                    backgroundColor: ['rgba(15, 118, 110, 0.6)', 'rgba(14, 165, 233, 0.6)'],
                    borderColor: ['rgb(15, 118, 110)', 'rgb(14, 165, 233)'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false, labels: { color: getChartColors().textColor } },
                    tooltip: {
                        callbacks: {
                            label: (context) => `עלות כוללת: ${formatCurrency(context.raw)}`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: (value) => formatCurrency(value),
                            color: getChartColors().textColor,
                        },
                        grid: {
                            color: getChartColors().gridColor,
                        }
                    },
                    x: {
                        ticks: {
                            color: getChartColors().textColor,
                        },
                        grid: {
                            display: false,
                        }
                    }
                }
            }
        });

        const breakdownCtx = document.getElementById('breakdownChart').getContext('2d');
        const breakdownChart = new Chart(breakdownCtx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: ['#0f766e', '#0ea5e9', '#f97316', '#eab308', '#84cc16'],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: getChartColors().textColor,
                        }
                    },
                    tooltip: {
                         callbacks: {
                            label: (context) => ` ${context.label}: ${formatCurrency(context.raw)}`
                        }
                    }
                }
            }
        });

        function calculateCosts() {
            const P = parseFloat(inputs.purchasePrice.value);
            const V_res = parseFloat(inputs.residualValue.value);
            const T_months = parseInt(inputs.comparisonPeriod.value);
            const T_years = T_months / 12;

            const D = parseFloat(inputs.downPayment.value);
            const i_annual = parseFloat(inputs.interestRate.value) / 100;
            const i_monthly = i_annual / 12;
            const loanAmount = P - D;
            const n_loan_payments = T_months;

            const C_ins_total = parseFloat(inputs.insuranceCost.value) * T_years;
            const C_lic_total = parseFloat(inputs.licenseFee.value) * T_years;
            const C_maint_total = parseFloat(inputs.maintenanceCost.value) * T_years;
            const C_fuel_total = parseFloat(inputs.fuelMiscCost.value) * T_years;

            const D_lease = parseFloat(inputs.leaseInitialPayment.value);
            const C_lease_monthly = parseFloat(inputs.leaseMonthlyPayment.value);
            const C_lease_total_payments = C_lease_monthly * T_months;
            
            const inv_rate_annual = parseFloat(inputs.investmentReturnRate.value) / 100;
            const inv_rate_monthly = inv_rate_annual / 12;

            const monthlyPayment = loanAmount > 0 ? (loanAmount * i_monthly * Math.pow(1 + i_monthly, n_loan_payments)) / (Math.pow(1 + i_monthly, n_loan_payments) - 1) : 0;
            const totalLoanPayments = monthlyPayment * n_loan_payments;
            const totalInterestPaid = totalLoanPayments - loanAmount;
            
            const depreciation = P - V_res;
            const totalCostBuy = D + totalLoanPayments + C_ins_total + C_lic_total + C_maint_total + C_fuel_total - V_res;
            
            const downPaymentDifference = D - D_lease;
            let opportunityCostReturn = 0;
            if (downPaymentDifference > 0) {
                 opportunityCostReturn = downPaymentDifference * Math.pow(1 + inv_rate_annual, T_years) - downPaymentDifference;
            }
            const totalCostLease = D_lease + C_lease_total_payments + C_fuel_total - opportunityCostReturn;
            
            const leaseCostsBreakdown = [C_lease_total_payments, D_lease, C_fuel_total, -opportunityCostReturn];
            const buyCostsBreakdown = [depreciation, totalInterestPaid, C_ins_total, C_lic_total + C_maint_total + C_fuel_total];

            updateUI(totalCostBuy, totalCostLease, buyCostsBreakdown, leaseCostsBreakdown);
        }

        function updateUI(costBuy, costLease, buyBreakdown, leaseBreakdown) {
            const difference = Math.abs(costBuy - costLease);
            if (costBuy < costLease) {
                summary.card.className = "p-6 rounded-2xl shadow-lg text-center transition-all duration-300 bg-teal-50 text-teal-800 dark:bg-teal-900/50 dark:text-teal-300";
                summary.title.textContent = "קנייה משתלמת יותר";
                summary.subtitle.textContent = `חיסכון של ${formatCurrency(difference)} לאורך התקופה`;
            } else {
                summary.card.className = "p-6 rounded-2xl shadow-lg text-center transition-all duration-300 bg-sky-50 text-sky-800 dark:bg-sky-900/50 dark:text-sky-300";
                summary.title.textContent = "ליסינג משתלם יותר";
                summary.subtitle.textContent = `חיסכון של ${formatCurrency(difference)} לאורך התקופה`;
            }

            comparisonChart.data.datasets[0].data = [costBuy, costLease];
            comparisonChart.update();

            updateBreakdownChart(buyBreakdown, leaseBreakdown);
        }

        function updateBreakdownChart(buyBreakdown, leaseBreakdown) {
            if (activeBreakdown === 'buy') {
                breakdownChart.data.labels = ['ירידת ערך', 'ריבית הלוואה', 'ביטוח', 'אחזקה ודלק'];
                breakdownChart.data.datasets[0].data = buyBreakdown;
            } else {
                breakdownChart.data.labels = ['תשלומים חודשיים', 'תשלום ראשוני', 'דלק והוצאות', 'החזר על השקעה'];
                breakdownChart.data.datasets[0].data = leaseBreakdown;
                breakdownChart.data.datasets[0].backgroundColor = ['#0ea5e9', '#38bdf8', '#f97316', '#84cc16'];
            }
            breakdownChart.update();
        }
        
        breakdownButtons.buy.addEventListener('click', () => {
            activeBreakdown = 'buy';
            breakdownButtons.buy.classList.add('bg-teal-600', 'text-white');
            breakdownButtons.buy.classList.remove('bg-white', 'text-teal-700');
            breakdownButtons.lease.classList.add('bg-white', 'text-teal-700');
            breakdownButtons.lease.classList.remove('bg-teal-600', 'text-white');
            calculateCosts();
        });

        breakdownButtons.lease.addEventListener('click', () => {
            activeBreakdown = 'lease';
            breakdownButtons.lease.classList.add('bg-teal-600', 'text-white');
            breakdownButtons.lease.classList.remove('bg-white', 'text-teal-700');
            breakdownButtons.buy.classList.add('bg-white', 'text-teal-700');
            breakdownButtons.buy.classList.remove('bg-teal-600', 'text-white');
            calculateCosts();
        });

        Object.values(inputs).forEach(input => {
            input.addEventListener('input', () => {
                updateValueDisplays();
                calculateCosts();
            });
        });

        const saveDeal = () => {
            const deal = {
                id: Date.now(),
                name: savedDeals.name.value || 'עסקה ללא שם',
                make: savedDeals.make.value || 'לא ידוע',
                purchasePrice: inputs.purchasePrice.value,
                residualValue: inputs.residualValue.value,
                comparisonPeriod: inputs.comparisonPeriod.value,
                downPayment: inputs.downPayment.value,
                interestRate: inputs.interestRate.value,
                leaseInitialPayment: inputs.leaseInitialPayment.value,
                leaseMonthlyPayment: inputs.leaseMonthlyPayment.value,
                insuranceCost: inputs.insuranceCost.value,
                licenseFee: inputs.licenseFee.value,
                maintenanceCost: inputs.maintenanceCost.value,
                fuelMiscCost: inputs.fuelMiscCost.value,
                investmentReturnRate: inputs.investmentReturnRate.value
            };
            let deals = JSON.parse(localStorage.getItem('carDeals')) || [];
            deals.push(deal);
            localStorage.setItem('carDeals', JSON.stringify(deals));
            renderSavedDeals();
            savedDeals.name.value = '';
            savedDeals.make.value = '';
        };

        const renderSavedDeals = () => {
            const deals = JSON.parse(localStorage.getItem('carDeals')) || [];
            savedDeals.list.innerHTML = '';
            if (deals.length === 0) {
                savedDeals.noDealsMessage.style.display = 'block';
            } else {
                savedDeals.noDealsMessage.style.display = 'none';
                deals.forEach(deal => {
                    const dealCard = document.createElement('div');
                    dealCard.className = 'bg-stone-100 dark:bg-slate-700 p-4 rounded-lg shadow flex flex-col md:flex-row justify-between items-center';
                    dealCard.innerHTML = `
                        <div>
                            <p class="font-bold text-teal-800 dark:text-teal-400">${deal.name}</p>
                            <p class="text-sm text-stone-600 dark:text-slate-400">יצרן: ${deal.make}</p>
                            <p class="text-sm text-stone-600 dark:text-slate-400">מחיר: ${formatCurrency(deal.purchasePrice)}</p>
                        </div>
                        <div class="flex space-x-2 space-x-reverse mt-4 md:mt-0">
                            <button class="load-btn text-sm bg-teal-600 text-white px-3 py-1 rounded-full hover:bg-teal-700 transition-colors dark:bg-teal-700 dark:hover:bg-teal-600" data-id="${deal.id}">
                                טען למחשבון
                            </button>
                            <button class="delete-btn text-sm bg-stone-300 text-stone-800 px-3 py-1 rounded-full hover:bg-stone-400 transition-colors dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500" data-id="${deal.id}">
                                מחק
                            </button>
                        </div>
                    `;
                    savedDeals.list.appendChild(dealCard);
                });
            }
        };

        const loadDeal = (id) => {
            const deals = JSON.parse(localStorage.getItem('carDeals')) || [];
            const deal = deals.find(d => d.id == id);
            if (deal) {
                for (const key in inputs) {
                    if (inputs[key].type === 'range' || inputs[key].type === 'number') {
                        inputs[key].value = deal[key];
                    }
                }
                updateValueDisplays();
                calculateCosts();
            }
        };

        const deleteDeal = (id) => {
            let deals = JSON.parse(localStorage.getItem('carDeals')) || [];
            deals = deals.filter(d => d.id != id);
            localStorage.setItem('carDeals', JSON.stringify(deals));
            renderSavedDeals();
        };

        savedDeals.btn.addEventListener('click', saveDeal);
        savedDeals.list.addEventListener('click', (e) => {
            if (e.target.classList.contains('load-btn')) {
                loadDeal(e.target.dataset.id);
            } else if (e.target.classList.contains('delete-btn')) {
                deleteDeal(e.target.dataset.id);
            }
        });

        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            themeToggleLightIcon.classList.remove('hidden');
            document.documentElement.classList.add('dark');
        } else {
            themeToggleDarkIcon.classList.remove('hidden');
            document.documentElement.classList.remove('dark');
        }

        themeToggleBtn.addEventListener('click', function() {
            themeToggleDarkIcon.classList.toggle('hidden');
            themeToggleLightIcon.classList.toggle('hidden');
            if (localStorage.getItem('color-theme')) {
                if (localStorage.getItem('color-theme') === 'light') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                }
            } else {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                }
            }

            // Update chart colors
            const newColors = getChartColors();

            comparisonChart.options.plugins.legend.labels.color = newColors.textColor;
            comparisonChart.options.scales.y.ticks.color = newColors.textColor;
            comparisonChart.options.scales.y.grid.color = newColors.gridColor;
            comparisonChart.options.scales.x.ticks.color = newColors.textColor;

            breakdownChart.options.plugins.legend.labels.color = newColors.textColor;

            comparisonChart.update();
            breakdownChart.update();
        });

        updateValueDisplays();
        calculateCosts();
        renderSavedDeals();

        const leftColumn = document.getElementById('left-column');
        const rightColumn = document.getElementById('right-column');
        let sortableLeft = null;
        let sortableRight = null;

        const initSortable = () => {
            if (window.innerWidth >= 1024) {
                if (!sortableLeft) {
                    sortableLeft = new Sortable(leftColumn, {
                        group: 'shared',
                        animation: 150,
                    });
                }
                if (!sortableRight) {
                    sortableRight = new Sortable(rightColumn, {
                        group: 'shared',
                        animation: 150,
                    });
                }
            } else {
                if (sortableLeft) {
                    sortableLeft.destroy();
                    sortableLeft = null;
                }
                if (sortableRight) {
                    sortableRight.destroy();
                    sortableRight = null;
                }
            }
        };

        initSortable();
        window.addEventListener('resize', initSortable);
    });
</script>
</body>
</html>
